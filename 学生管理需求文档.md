# 学生管理需求文档

**版本：v2.0**
**最后更新：2024-10-24**

---

## 版本历史
- **v1.0**: 初始版本，包含“全部学生”和“学生分组”基础功能。
- **v2.0**: 新增“预警标签”和“智能分组”功能，并为多学科教师增加“学科选择器”。

---

## 一、 总览

### 1. 整体布局
- 采用顶部标签页切换的布局，分为“全部学生”和“学生分组”两个主要功能区。
- 页面左上角提供班级选择器，用于筛选和定位要管理的班级范围。

### 2. 通用组件：学科选择器
- **显示逻辑：**
    - 若教师在该班级仅负责一个学科，则不显示选择器。
    - 若教师负责多个学科，则在页面顶部显示学科选择器。
- **默认状态：** 默认选中教师所负责的学科列表中的第一个。
- **功能：** 切换学科后，下方学生卡片中的“预警标签”数据会相应更新。

## 二、 全部学生
该标签页以卡片形式，集中展示所选班级和学科下的所有学生信息。

### 1. 预警标签
- **显示逻辑：** 当学生满足以下任一条件时，显示预警标签：
    - **成绩排名后20%：** 学生最近5次已评分作业的总得分率（正确题数 / 总题数）在班级排名后20%。**若存在并列，则所有并列学生均视为满足条件。**
    - **得分率低于70%：** 学生最近5次已评分作业的总得分率低于70%。
    - *(注：以上两个条件为 **并集/OR** 关系，满足其一即可触发预警。)*
- **标签内容：** 标签上直接显示计算出的总得分率。
- **交互行为：** 点击 **整个学生卡片**（无论是否显示预警标签），均跳转至 **“数据分析-学生数据”** 界面，并自动传入当前班级、所选学科和该学生的信息，以展示对应的详细数据。

### 2. 学生信息展示
- **卡片内容：** 每张卡片包含学生的头像、姓名、学号和预警标签。
- **头像逻辑：**
    - 根据学生的性别展示对应的男/女头像。
    - 若学生性别信息缺失，则展示默认头像。
- **学号逻辑：**
    - 若学生有学号，则显示其学号。
    - 若学生无学号，则显示“--”。
- **数据展示：** 该页面将一次性展示所选班级的所有学生，不进行分页。

## 三、 学生分组
该标签页提供对学生进行手动或智能分组的管理功能。

### 1. 分组方案管理
- **页面布局：** 页面分为左右两栏。左侧为“分组方案”列表，右侧为当前选定方案下的“小组”列表。
- **分组方案：**
    - **默认方案：** 每个班级、每个学科将自动初始化一个默认方案，名为“课后作业分组”。该方案包含“提升组”、“基础组”、“薄弱组”三个默认小组。
    - **方案列表内容：** 每个方案条目除了名称外，还会显示其所属学科以及分组情况（已分配人数和未分配人数）。**现在，左侧的方案列表将只显示该班级下，该老师所负责的、且与顶部学科选择器当前选中学科关联的分组方案。**
    - **创建方案：**
        - **触发方式：** 点击“创建分组方案”按钮。
        - **弹窗表单：** 包含“方案名称”和“关联学科”两个必填字段。
        - **方案名称：** 输入框，限制20个字符以内。
        - **关联学科：**
            - 若教师仅负责该班级的一个学科，该字段将自动填充为该学科并禁用。
            - 若教师负责多个学科，该字段默认为空，教师可从下拉列表中选择所负责的学科。
            **现在，该字段将默认选中顶部学科选择器中当前选中的学科，且不可编辑。**
        - **表单校验：** 提交时，若必填字段为空，将进行校验提示。
        - **唯一性校验：** 同一班级下，同一学科的方案名称不得重复。若重复，将进行Toast提示，提示文案：“该方案名称已存在，请修改后重试”。
    - **方案列表操作：**
        - 列表右侧有“更多”按钮，鼠标悬停时显示“重命名”和“删除”选项。
        - **重命名：**
            - **触发方式：** 点击“重命名”按钮。
            - **弹窗：** 可编辑方案名称。
            - **唯一性校验：** 重命名后的方案名称在同一班级、同一学科下不得与已有方案重复，否则进行Toast提示，提示文案：“该方案名称已存在，请修改后重试”。
        - **删除：**
            - **触发方式：** 点击“删除”按钮。
            - **二次确认：** 将弹出二次确认弹窗。
            - **删除前校验：** 如果该学科当前仅存在一个分组方案，则禁止删除，并进行Toast提示，提示文案：“该学科至少需保留一个分组方案”。

### 2. 智能分组
- **触发方式：** 在分组方案右侧的方案设置区，点击“智能分组”按钮。
- **核心功能：** 该功能会 **清除** 方案内原有的小组及学生分配情况，根据用户设置的规则 **创建新的小组** 并自动分配学生。
- **操作流程：**
    - **步骤一：设置基本参数**
        - **参考时段：** 选择用于计算学生得分率的作业时间范围（默认值：“近六个月”）。
        - **分组数量：** 设置希望创建的小组数量（默认值：3）。
        - **下一步校验：** 点击“下一步”时，系统将进行校验，若校验失败，则进行对应的Toast提示：
            - **规则：** 该学科下必须有学生。
                - **提示：** “该科目没有学生，无法进行智能分组”
            - **规则：** 班级学生总数必须不小于要创建的分组数量。
                - **提示：** “学生数量不足，无法分成 [分组数量] 组”
            - **规则：** 所选时段内必须有已评分的作业数据。
                - **提示：** “该时段无评分作业，请更换时段”
    - **步骤二：划分得分率区间**
        - **交互方式：** 通过拖动滑块，设置各小组的得分率区间。
        - **实时预览：** 界面下方会根据滑块位置，实时显示各区间内的学生人数。
        - **区间规则：** 区间包含起始边界值，但不包含截止边界值（例如`[60%-80%)`）。得分率为60%的学生会被分入此组，80%的则不会。
        - **默认划分算法 (供开发参考):**
            - **目标：** 根据所选时段内所有学生的得分率，自动计算并生成一组默认的分组区间，使得各分组人数尽可能均衡。
            - **核心思想：** 使用 **分位点（Quantile）** 思想来确定分界点，而不是简单地按百分比等分。例如，若要分3组，则寻找33.3%和66.7%分位点作为分割依据。
            - **关键处理（同分处理）：** 算法的核心是确保得分率相同的学生不会被分到不同的小组。如果理论上的分界点恰好落在几个得分相同的学生中间，系统会自动将分界点向下取整到该相同分数的起始位置，从而将这些学生划分到同一个组内。
            - **伪代码实现参考：**
              ```
              function calculateInitialBoundaries(studentScores, groupCount):
                  // studentScores: 已按得分率从小到大排序的学生列表 [{id, scoreRate}, ...]
                  // groupCount: 目标分组数量
                  
                  studentCount = studentScores.length
                  boundaries = [0] // 存储最终的得分率边界，初始为0%
                  
                  // 1. 计算理论分界点
                  for i = 1 to (groupCount - 1):
                      // 找到理论分割点的位置索引
                      idealIndex = floor((studentCount / groupCount) * i)
                      
                      // 获取该位置的得分率
                      boundaryScore = studentScores[idealIndex].scoreRate
                      
                      // 2. 调整分界点以处理同分情况
                      // 从理论分割点向前查找，找到第一个得分率不等于boundaryScore的学生
                      adjustedIndex = idealIndex
                      while adjustedIndex > 0 and studentScores[adjustedIndex - 1].scoreRate == boundaryScore:
                          adjustedIndex = adjustedIndex - 1
                      
                      // 将调整后的分界点得分率加入结果
                      // 确保不与上一个分界点重复
                      if studentScores[adjustedIndex].scoreRate > last(boundaries):
                          boundaries.push(studentScores[adjustedIndex].scoreRate)

                  boundaries.push(100) // 结束边界为100%
                  return boundaries // 返回 [0, score1, score2, ..., 100]
              ```
            - **示例：**
                - **输入：** 11名学生，得分率 `[45, 52, 58, 65, 65, 72, 78, 85, 88, 92, 95]`， 分为 `3` 组。
                - **计算：** 理论分界点在 11/3≈3.6 (第4位) 和 11*2/3≈7.3 (第8位)。
                    - 第一个分界点得分 `65%`。由于存在同分，向前找到第一个 `65%` 的位置。
                    - 第二个分界点得分 `85%`。
                - **输出：** 分界点为 `[0, 65, 85, 100]`。对应分组区间 `[0-65%)`, `[65-85%)`, `[85-100%]`。
                    - 各组人数为：4人、4人、3人，达到均衡。
    - **完成分组：**
        - 点击“确认分组”按钮后，系统将根据最终设置的得分率区间完成分组。

### 3. 小组及成员管理
- **待分配卡片：**
    - **显示逻辑：** 当有学生尚未分组时，页面顶部显示“待分配”卡片，并显示待分配学生人数。
    - **成员：** 初始创建新方案时，该班级所有学生均位于“待分配”卡片中。
- **添加小组：**
    - **按钮位置：** 位于小组列表顶部。若“待分配”卡片存在，则位于其下方。
    - **操作结果：** 点击后，将在按钮下方新增一个小组卡片。
    - **默认名称：** 新增小组的默认名称为“小组N”，N为当前小组数量的序号（例如：小组1，小组2，...）。
    - **编辑状态：** 小组名称创建时默认为可编辑状态，用户可通过点击离焦或按回车键保存。后续可通过双击激活编辑状态。
- **小组卡片操作：**
    - **更多按钮：** 鼠标悬停时显示“重命名”和“删除”选项。
    - **重命名：** 激活小组名称的编辑状态。
    - **删除：**
        - **二次确认：** 弹出二次确认弹窗。
        - **操作结果：** 确认后删除该小组，小组中的所有学生将自动移回“待分配”卡片中。
- **学生分配：**
    - **交互方式：**
        - **选中移动：**
            - 学生姓名卡片支持点击选中/取消选中，可多选。
            - 当有学生被选中时，卡片右上角会出现两个按钮：“取消选择”和“移动到...”。
            - **取消选择：** 点击后，将取消当前卡片中所有学生的选中状态。
            - **移动到...：** 鼠标悬停，会展开可移动的目标小组列表。
    - **移动规则：**
        - **待分配学生移动：** 若选中的是“待分配”卡片中的学生，下拉选项为所有已创建的小组。
        - **小组学生移动：** 若选中的是某个小组中的学生，下拉选项为所有其他小组及“待分配”。
    - **操作限制：**
        - **单卡片操作：** 一次操作只能针对一个卡片（即“待分配”或某个小组）中的学生。
        - **跨组选择：** 不允许同时选中不同卡片（例如：待分配和小组A）中的学生。若尝试跨组选择，将弹出Toast提示，提示文案：“请勿跨组选择学生”。

## 四、 缺省界面
- **显示逻辑：** 当所选班级没有学生时，整个“学生管理”模块（包括“全部学生”和“学生分组”两个标签页）都将显示一个统一的缺省界面。
- **提示内容：** 缺省界面将提示用户“当前班级没有学生，请联系管理员导入学生”。
